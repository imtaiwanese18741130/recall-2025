<!DOCTYPE html>
<html lang="zh-Hant">
<head>
	{{ template "common-head" . }}
  <title>阻止失能暴衝的立院, 我們需要你！</title>
  <meta name="description" property="og:description" content="不討論就表決，邊撤案邊修正，毀壞憲政體制的立院你還看得下去嗎？你知道立法院過去兩個會期強推了多少危害國安、違憲、危害臺灣民主體制、危害民生經濟的法案嗎？身為民主社會的公民，我們應行使罷免權，讓不適任的立委下台！">
</head>
<body>
  <div class="banner">
		<div class="section">
    	<h1 class="primary">阻止失能暴衝的立院, 我們需要你！</h1>
    	<div class="content-text">不討論就表決，邊撤案邊修正，毀壞憲政體制的立院你還看得下去嗎？<br>你知道立法院過去兩個會期強推了多少危害國安、違憲、危害臺灣民主體制、危害民生經濟的法案嗎? 身為民主社會的公民，我們應行使罷免權，讓不適任的立委下台！</div>
		</div>
  </div>
  <div class="section candidates mt-md  mt-sm-xs">
		<div class="zone-filters-container" id="zone-filters-container">
			<div class="filters pb-sm">
				<h2>輸入戶籍地，<br>找出您有權罷免的立委</h2>
				<div class="row">
					<div class="col-6 col-xs-12">
						<select id="filter-municipalities">
							<option value="" disabled selected>縣市</option>
							{{range $m := .Municipalities}}
							{{if gt $m.Id 0}}
							<option value="{{$m.Id}}">{{$m.Name}}</option>
							{{end}}
							{{end}}
						</select>
					</div>
					<div class="col-6 col-xs-12">
						<select id="filter-districts" disabled>
							<option value="" disabled selected>行政區</option>
						</select>
					</div>
					<div class="col-12">
						<select id="filter-wards" disabled>
							<option value="" disabled selected>鄉里名</option>
						</select>
					</div>
				</div>
			</div>
			<div class="filtered-candidate-container" id="filtered-candidate-container">
			</div>
			<div class="filtered-candidate-container safe" id="share-container" style="display:none;">
				<div class="candidate-container">
					<div class="candidate">
						<div class="candidate-name">您的選區不在本次活動範圍</div>
						<div class="candidate-zone">但我們也需要您的力量，幫忙分享資訊讓更多人參與!</div>
					</div>
					<button class="btn-black lg w100" onclick="copyCurrentLink()">幫忙分享資訊!</button>
				</div>
			</div>
		</div>
    <h2 class="mt-lg">全台罷免對象一覽</h2>
		<ul>
			{{range $a := .Areas }}
			<li class="city-row">
				<div class="city-header">
					<div class="city-name">{{$a.MunicipalityName}}</div><div class="arrow">▶</div>
				</div>
				<div class="city-content">
					<ul>
						{{range $rl := $a.RecallLegislators}}
						<li>
							<div class="candidate">
								<div class="candidate-name">{{$rl.PoliticianName}}<div class="tag-stage stage-{{.RecallStage}}">{{.RecallStage}} 階</div></div>
								<div class="candidate-zone">{{$rl.ConstituencyName}}</div>
							</div>
							<div class="candidate-action">
								{{if $rl.FormDeployed}}
								<a href="#zone-filters-container"><button class="btn-primary md w100">連署罷免</button></a>
								{{else}}
								<div style="color:#aaaaaa;">趕工中</div>
								{{end}}
							</div>
						</li>
						{{end}}
					</ul>
				</div>
			</li>
			{{end}}
		</ul>
  </div>

	{{ template "faq" }}
	{{ template "footer" }}
	<div id="popout" class="hidden">已複製到剪貼簿</div>
	<script>
		const baseURL = '{{.BaseURL}}';

  	document.querySelectorAll('.city-row .city-header').forEach(header => {
  	  header.addEventListener('click', () => {
  	    const item = header.parentElement;
  	    const isExpanded = item.classList.contains('expanded');
  	    document.querySelectorAll('.city-row.expanded').forEach(openItem => {
  	      if (openItem !== item) {
  	        openItem.classList.remove('expanded');
  	        const arrow = openItem.querySelector('.arrow');
  	        arrow.classList.remove('collapsed');
  	      }
  	    });
  	    item.classList.toggle('expanded', !isExpanded);
  	    const arrow = header.querySelector('.arrow');
  	    arrow.classList.toggle('collapsed', !isExpanded);
  	  });
  	});

		const filteredCandidateContainer = document.getElementById('filtered-candidate-container');
		const shareContainer = document.getElementById('share-container');

		async function sendAjaxRequest(municipality, district, ward) {
			let params = new URLSearchParams();

			if (municipality !== null && municipality !== undefined) {
				params.append("municipality", municipality);
			}
			if (district !== null && district !== undefined) {
				params.append("district", district);
			}
			if (ward !== null && ward !== undefined) {
				params.append("ward", ward);
			}

			let fullUrl = `${baseURL}/apis/constituencies?${params.toString()}`;

			try {
				let response = await fetch(fullUrl, {method: "GET"});

				if (!response.ok && response.status !== 404) {
					let error = new Error(`HTTP Error: ${response.status}`);
					error.status = response.status;
					throw error;
				}

				return await response.json();
			} catch (error) {
				throw error;
			}
		}

		document.addEventListener("DOMContentLoaded", () => {
			const municipalitiesSelect = document.getElementById("filter-municipalities");
			const districtsSelect = document.getElementById("filter-districts");
			const wardsSelect = document.getElementById("filter-wards");

			const resetSelect = (select) => {
				const defaultOption = select.querySelector('option[value=""]');
				select.disabled = true;
				select.innerHTML = "";
				if (defaultOption) {
					select.appendChild(defaultOption.cloneNode(true));
				}
			};

			const populateOptions = (select, divisions) => {
				divisions.forEach(division => {
					const elem = document.createElement("option");
					elem.value = division.id;
					elem.textContent = division.n;
					select.appendChild(elem);
				});
				select.disabled = false;
			};

			municipalitiesSelect.addEventListener("change", () => {
				filteredCandidateContainer.innerHTML = "";
				shareContainer.style.display = "none";
				resetSelect(districtsSelect);
				resetSelect(wardsSelect);

				sendAjaxRequest(municipalitiesSelect.value, null, null)
					.then(data => {
						if (!Object.hasOwn(data, "result")) {
							showShareContainer();
						} else if (Object.hasOwn(data.result, "divisions")) {
							populateOptions(districtsSelect, data.result.divisions);
						} else {
							console.error("invalid municipality");
						}
					})
					.catch(error => {
						console.error(error);
					});
			});

			districtsSelect.addEventListener("change", () => {
				filteredCandidateContainer.innerHTML = "";
				shareContainer.style.display = "none";
				resetSelect(wardsSelect);

				sendAjaxRequest(municipalitiesSelect.value, districtsSelect.value, null)
					.then(data => {
						if (!Object.hasOwn(data, "result")) {
							showShareContainer();
						} else if (Object.hasOwn(data.result, "divisions")) {
							populateOptions(wardsSelect, data.result.divisions);
						} else {
							console.error("invalid district");
						}
					})
					.catch(error => {
						console.error(error);
					});
			});

			wardsSelect.addEventListener("change", () => {
				filteredCandidateContainer.innerHTML = "";
				shareContainer.style.display = "none";
				sendAjaxRequest(municipalitiesSelect.value, districtsSelect.value, wardsSelect.value)
					.then(data => {
						if (!Object.hasOwn(data, "result")) {
							showShareContainer();
						} else if (Object.hasOwn(data.result, "legislators")) {
							const address = municipalitiesSelect.selectedOptions[0].text + districtsSelect.selectedOptions[0].text + wardsSelect.selectedOptions[0].text;
							showFilteredCandidateContainer(data.result.legislators, address);
						} else {
							console.error("invalid ward");
						}
					})
					.catch(error => {
						console.error(error);
					});
			});
		});

		function showFilteredCandidateContainer(legislators, address) {
			if (Array.isArray(legislators)) {
				legislators.forEach(legislator => {
					const candidateContainer = document.createElement("div");
					candidateContainer.classList.add("candidate-container");
					candidateContainer.innerHTML = `
						<div class="candidate">
							<div class="candidate-name">${legislator.politicianName}<div class="tag-stage stage-${legislator.recallStage}">${legislator.recallStage} 階</div></div>
							<div class="candidate-zone">${legislator.constituencyName}</div>
						</div>
						<div class="candidate-action">
							<a href="${legislator.fillFormURL}?address=${address}"><button class="btn-primary lg w100">連署罷免</button></a>
						</div>`;
					filteredCandidateContainer.appendChild(candidateContainer);
				});

				filteredCandidateContainer.scrollIntoView({behavior: "smooth"});
			}
		}

		function showShareContainer() {
			shareContainer.style.display = "block";
			shareContainer.scrollIntoView({behavior: "smooth"});
		}
	</script>
</body>
</html>
